<!-- saved from url=(0014)about:internet -->
<pre class="code">
<span class="srcline"><span class="lineno"><a href="68,1" id="srcline1"> 1</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S2T16U3">x</span>,<span class="var type1" id="S3T1U4">P</span>]=ukf(<span class="var type1" id="S2T16U7">x</span>,<span class="var type1" id="S3T1U8">P</span>,<span class="var type1" id="S4T2U9">z</span>,<span class="var type1" id="S5T1U10">Q</span>,<span class="var type1" id="S6T2U11">R</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="68,2" id="srcline2"> 2</a></span><span class="line"><span class="comment">% UKF   Unscented Kalman Filter for nonlinear dynamic systems</span></span></span>
<span class="srcline"><span class="lineno"><a href="68,3" id="srcline3"> 3</a></span><span class="line"><span class="comment">% [x, P] = ukf(f,x,P,h,z,Q,R) returns state estimate, x and state covariance, P </span></span></span>
<span class="srcline"><span class="lineno"><a href="68,4" id="srcline4"> 4</a></span><span class="line"><span class="comment">% for nonlinear dynamic system (for simplicity, noises are assumed as additive):</span></span></span>
<span class="srcline"><span class="lineno"><a href="68,5" id="srcline5"> 5</a></span><span class="line"><span class="comment">%           x_k+1 = f(x_k) + w_k</span></span></span>
<span class="srcline"><span class="lineno"><a href="68,6" id="srcline6"> 6</a></span><span class="line"><span class="comment">%           z_k   = h(x_k) + v_k</span></span></span>
<span class="srcline"><span class="lineno"><a href="68,7" id="srcline7"> 7</a></span><span class="line"><span class="comment">% where w ~ N(0,Q) meaning w is gaussian noise with covariance Q</span></span></span>
<span class="srcline"><span class="lineno"><a href="68,8" id="srcline8"> 8</a></span><span class="line"><span class="comment">%       v ~ N(0,R) meaning v is gaussian noise with covariance R</span></span></span>
<span class="srcline"><span class="lineno"><a href="68,9" id="srcline9"> 9</a></span><span class="line"><span class="comment">% Inputs:   f: function handle for f(x)</span></span></span>
<span class="srcline"><span class="lineno"><a href="68,10" id="srcline10">10</a></span><span class="line"><span class="comment">%           x: "a priori" state estimate</span></span></span>
<span class="srcline"><span class="lineno"><a href="68,11" id="srcline11">11</a></span><span class="line"><span class="comment">%           P: "a priori" estimated state covariance</span></span></span>
<span class="srcline"><span class="lineno"><a href="68,12" id="srcline12">12</a></span><span class="line"><span class="comment">%           h: fanction handle for h(x)</span></span></span>
<span class="srcline"><span class="lineno"><a href="68,13" id="srcline13">13</a></span><span class="line"><span class="comment">%           z: current measurement</span></span></span>
<span class="srcline"><span class="lineno"><a href="68,14" id="srcline14">14</a></span><span class="line"><span class="comment">%           Q: process noise covariance </span></span></span>
<span class="srcline"><span class="lineno"><a href="68,15" id="srcline15">15</a></span><span class="line"><span class="comment">%           R: measurement noise covariance</span></span></span>
<span class="srcline"><span class="lineno"><a href="68,16" id="srcline16">16</a></span><span class="line"><span class="comment">% Output:   x: "a posteriori" state estimate</span></span></span>
<span class="srcline"><span class="lineno"><a href="68,17" id="srcline17">17</a></span><span class="line"><span class="comment">%           P: "a posteriori" state covariance</span></span></span>
<span class="srcline"><span class="lineno"><a href="68,18" id="srcline18">18</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="68,19" id="srcline19">19</a></span><span class="line"><span class="comment">% Example:</span></span></span>
<span class="srcline"><span class="lineno"><a href="68,20" id="srcline20">20</a></span><span class="line"><span class="comment"><span class="comment">%{</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="68,21" id="srcline21">21</a></span><span class="line"><span class="comment">n=3;      <span class="comment">%number of state</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="68,22" id="srcline22">22</a></span><span class="line"><span class="comment">q=0.1;    <span class="comment">%std of process </span></span></span></span>
<span class="srcline"><span class="lineno"><a href="68,23" id="srcline23">23</a></span><span class="line"><span class="comment">r=0.1;    <span class="comment">%std of measurement</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="68,24" id="srcline24">24</a></span><span class="line"><span class="comment">Q=q^2*eye(n); <span class="comment">% covariance of process</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="68,25" id="srcline25">25</a></span><span class="line"><span class="comment">R=r^2;        <span class="comment">% covariance of measurement  </span></span></span></span>
<span class="srcline"><span class="lineno"><a href="68,26" id="srcline26">26</a></span><span class="line"><span class="comment">f=@(x)[x(2);x(3);0.05*x(1)*(x(2)+x(3))];  <span class="comment">% nonlinear state equations</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="68,27" id="srcline27">27</a></span><span class="line"><span class="comment">h=@(x)x(1);                               <span class="comment">% measurement equation</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="68,28" id="srcline28">28</a></span><span class="line"><span class="comment">s=[0;0;1];                                <span class="comment">% initial state</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="68,29" id="srcline29">29</a></span><span class="line"><span class="comment">x=s+q*randn(3,1); <span class="comment">%initial state          % initial state with noise</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="68,30" id="srcline30">30</a></span><span class="line"><span class="comment">P = eye(n);                               <span class="comment">% initial state covraiance</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="68,31" id="srcline31">31</a></span><span class="line"><span class="comment">N=20;                                     <span class="comment">% total dynamic steps</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="68,32" id="srcline32">32</a></span><span class="line"><span class="comment">xV = zeros(n,N);          <span class="comment">%estmate        % allocate memory</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="68,33" id="srcline33">33</a></span><span class="line"><span class="comment">sV = zeros(n,N);          <span class="comment">%actual</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="68,34" id="srcline34">34</a></span><span class="line"><span class="comment">zV = zeros(1,N);</span></span></span>
<span class="srcline"><span class="lineno"><a href="68,35" id="srcline35">35</a></span><span class="line"><span class="comment">for k=1:N</span></span></span>
<span class="srcline"><span class="lineno"><a href="68,36" id="srcline36">36</a></span><span class="line"><span class="comment">  z = h(s) + r*randn;                     <span class="comment">% measurments</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="68,37" id="srcline37">37</a></span><span class="line"><span class="comment">  sV(:,k)= s;                             <span class="comment">% save actual state</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="68,38" id="srcline38">38</a></span><span class="line"><span class="comment">  zV(k)  = z;                             <span class="comment">% save measurment</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="68,39" id="srcline39">39</a></span><span class="line"><span class="comment">  [x, P] = ukf(f,x,P,h,z,Q,R);            <span class="comment">% ekf </span></span></span></span>
<span class="srcline"><span class="lineno"><a href="68,40" id="srcline40">40</a></span><span class="line"><span class="comment">  xV(:,k) = x;                            <span class="comment">% save estimate</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="68,41" id="srcline41">41</a></span><span class="line"><span class="comment">  s = f(s) + q*randn(3,1);                <span class="comment">% update process </span></span></span></span>
<span class="srcline"><span class="lineno"><a href="68,42" id="srcline42">42</a></span><span class="line"><span class="comment">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="68,43" id="srcline43">43</a></span><span class="line"><span class="comment">for k=1:3                                 <span class="comment">% plot results</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="68,44" id="srcline44">44</a></span><span class="line"><span class="comment">  subplot(3,1,k)</span></span></span>
<span class="srcline"><span class="lineno"><a href="68,45" id="srcline45">45</a></span><span class="line"><span class="comment">  plot(1:N, sV(k,:), '-', 1:N, xV(k,:), '--')</span></span></span>
<span class="srcline"><span class="lineno"><a href="68,46" id="srcline46">46</a></span><span class="line"><span class="comment">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="68,47" id="srcline47">47</a></span><span class="line"><span class="comment"><span class="comment">%}</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="68,48" id="srcline48">48</a></span><span class="line"><span class="comment">% Reference: Julier, SJ. and Uhlmann, J.K., Unscented Filtering and</span></span></span>
<span class="srcline"><span class="lineno"><a href="68,49" id="srcline49">49</a></span><span class="line"><span class="comment">% Nonlinear Estimation, Proceedings of the IEEE, Vol. 92, No. 3,</span></span></span>
<span class="srcline"><span class="lineno"><a href="68,50" id="srcline50">50</a></span><span class="line"><span class="comment">% pp.401-422, 2004. </span></span></span>
<span class="srcline"><span class="lineno"><a href="68,51" id="srcline51">51</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="68,52" id="srcline52">52</a></span><span class="line"><span class="comment">% By Yi Cao at Cranfield University, 04/01/2008</span></span></span>
<span class="srcline"><span class="lineno"><a href="68,53" id="srcline53">53</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="68,54" id="srcline54">54</a></span><span class="line"><span class="mxinfo " id="T2:U8"><span class="var type1" id="S7T2U14">L</span>=<span class="mxinfo " id="T2:U10">numel(<span class="var type1" id="S2T16U17">x</span>)</span></span>;                                 <span class="comment">%numer of states</span></span></span>
<span class="srcline"><span class="lineno"><a href="68,55" id="srcline55">55</a></span><span class="line"><span class="mxinfo " id="T2:U12"><span class="var type1" id="S9T2U20">m</span>=<span class="mxinfo " id="T2:U14">numel(<span class="var type1" id="S4T2U23">z</span>)</span></span>;                                 <span class="comment">%numer of measurements</span></span></span>
<span class="srcline"><span class="lineno"><a href="68,56" id="srcline56">56</a></span><span class="line"><span class="mxinfo " id="T2:U16"><span class="var type1" id="S10T2U26">alpha</span>=<span class="mxinfo " id="T2:U18">1e-3</span></span>;                                 <span class="comment">%default, tunable</span></span></span>
<span class="srcline"><span class="lineno"><a href="68,57" id="srcline57">57</a></span><span class="line"><span class="mxinfo " id="T2:U19"><span class="var type1" id="S11T2U30">ki</span>=<span class="mxinfo " id="T2:U21">0</span></span>;                                       <span class="comment">%default, tunable</span></span></span>
<span class="srcline"><span class="lineno"><a href="68,58" id="srcline58">58</a></span><span class="line"><span class="mxinfo " id="T2:U22"><span class="var type1" id="S12T2U34">beta</span>=<span class="mxinfo " id="T2:U24">2</span></span>;                                     <span class="comment">%default, tunable</span></span></span>
<span class="srcline"><span class="lineno"><a href="68,59" id="srcline59">59</a></span><span class="line"><span class="mxinfo " id="T2:U25"><span class="var type1" id="S13T2U38">lambda</span>=<span class="mxinfo " id="T2:U27"><span class="var type1" id="S10T2U42">alpha</span>^2*(<span class="var type1" id="S7T2U46">L</span>+<span class="var type1" id="S11T2U47">ki</span>)-<span class="var type1" id="S7T2U48">L</span></span></span>;                    <span class="comment">%scaling factor</span></span></span>
<span class="srcline"><span class="lineno"><a href="68,60" id="srcline60">60</a></span><span class="line"><span class="mxinfo " id="T2:U32"><span class="var type1" id="S14T2U51">c</span>=<span class="mxinfo " id="T2:U34"><span class="var type1" id="S7T2U53">L</span>+<span class="var type1" id="S13T2U54">lambda</span></span></span>;                                 <span class="comment">%scaling factor</span></span></span>
<span class="srcline"><span class="lineno"><a href="68,61" id="srcline61">61</a></span><span class="line"><span class="mxinfo " id="T30:U37"><span class="var type1" id="S15T30U57">Wm</span>=<span class="mxinfo " id="T30:U39">[<span class="var type1" id="S13T2U61">lambda</span>/<span class="var type1" id="S14T2U62">c</span> 0.5/<span class="var type1" id="S14T2U66">c</span>+zeros(<span class="mxinfo " id="T2:U43">1</span>,<span class="mxinfo " id="T2:U44">2*<span class="var type1" id="S7T2U72">L</span></span>)]</span></span>;           <span class="comment">%weights for means</span></span></span>
<span class="srcline"><span class="lineno"><a href="68,62" id="srcline62">62</a></span><span class="line"><span class="mxinfo " id="T30:U46"><span class="var type1" id="S17T30U75">Wc</span>=<span class="var type1" id="S15T30U76">Wm</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="68,63" id="srcline63">63</a></span><span class="line"><span class="mxinfo " id="T2:U49"><span class="mxinfo " id="T2:U50"><span class="var type1" id="S17T30U80">Wc</span>(<span class="mxinfo " id="T12:U52">1</span>)</span>=<span class="mxinfo " id="T2:U53"><span class="var type1" id="S17T30U84">Wc</span>(1)+(1-<span class="var type1" id="S10T2U91">alpha</span>^2+<span class="var type1" id="S12T2U93">beta</span>)</span></span>;               <span class="comment">%weights for covariance</span></span></span>
<span class="srcline"><span class="lineno"><a href="68,64" id="srcline64">64</a></span><span class="line"><span class="mxinfo " id="T2:U57"><span class="var type1" id="S14T2U96">c</span>=<span class="mxinfo " id="T2:U59">sqrt(<span class="var type1" id="S14T2U99">c</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="68,65" id="srcline65">65</a></span><span class="line"><span class="mxinfo " id="T29:U61"><span class="var type1" id="S19T29U102">X</span>=<span class="mxinfo " id="T29:U63"><span class="fcn" id="F68N7:B104">sigmas</span>(<span class="var type1" id="S2T16U105">x</span>,<span class="var type1" id="S3T1U106">P</span>,<span class="var type1" id="S14T2U107">c</span>)</span></span>;                            <span class="comment">%sigma points around x</span></span></span>
<span class="srcline"><span class="lineno"><a href="68,66" id="srcline66">66</a></span><span class="line">[<span class="var type1" id="S21T16U111">x1</span>,<span class="var type1" id="S22T29U112">X1</span>,<span class="var type1" id="S23T1U113">P1</span>,<span class="var type1" id="S24T29U114">X2</span>]=<span class="fcn" id="F155N10:B116">ut</span>(0,<span class="var type1" id="S19T29U118">X</span>,<span class="var type1" id="S15T30U119">Wm</span>,<span class="var type1" id="S17T30U120">Wc</span>,<span class="var type1" id="S7T2U121">L</span>,<span class="var type1" id="S5T1U122">Q</span>);          <span class="comment">%unscented transformation of process</span></span></span>
<span class="srcline"><span class="lineno"><a href="68,67" id="srcline67">67</a></span><span class="line"><span class="comment">% X1=sigmas(x1,P1,c);                         %sigma points around x1</span></span></span>
<span class="srcline"><span class="lineno"><a href="68,68" id="srcline68">68</a></span><span class="line"><span class="comment">% X2=X1-x1(:,ones(1,size(X1,2)));             %deviation of X1</span></span></span>
<span class="srcline"><span class="lineno"><a href="68,69" id="srcline69">69</a></span><span class="line">[<span class="var type1" id="S26T2U126">z1</span>,<span class="var type1" id="S27T30U127">Z1</span>,<span class="var type1" id="S28T2U128">P2</span>,<span class="var type1" id="S29T30U129">Z2</span>]=<span class="fcn" id="F193N10:B131">ut</span>(1,<span class="var type1" id="S22T29U133">X1</span>,<span class="var type1" id="S15T30U134">Wm</span>,<span class="var type1" id="S17T30U135">Wc</span>,<span class="var type1" id="S9T2U136">m</span>,<span class="var type1" id="S6T2U137">R</span>);       <span class="comment">%unscented transformation of measurments</span></span></span>
<span class="srcline"><span class="lineno"><a href="68,70" id="srcline70">70</a></span><span class="line"><span class="mxinfo " id="T16:U85"><span class="var type1" id="S30T16U140">P12</span>=<span class="mxinfo " id="T16:U87"><span class="mxinfo " id="T29:U88"><span class="var type1" id="S24T29U143">X2</span>*<span class="mxinfo " id="T31:U90">diag(<span class="var type1" id="S17T30U146">Wc</span>)</span></span>*<span class="mxinfo " id="T38:U92"><span class="var type1" id="S29T30U148">Z2</span>'</span></span></span>;                        <span class="comment">%transformed cross-covariance</span></span></span>
<span class="srcline"><span class="lineno"><a href="68,71" id="srcline71">71</a></span><span class="line"><span class="mxinfo " id="T16:U94"><span class="var type1" id="S32T16U151">K</span>=<span class="mxinfo " id="T16:U96"><span class="var type1" id="S30T16U153">P12</span>*<span class="mxinfo " id="T2:U98">inv(<span class="var type1" id="S28T2U156">P2</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="68,72" id="srcline72">72</a></span><span class="line"><span class="mxinfo " id="T16:U100"><span class="var type1" id="S2T16U159">x</span>=<span class="mxinfo " id="T16:U102"><span class="var type1" id="S21T16U161">x1</span>+<span class="mxinfo " id="T16:U104"><span class="var type1" id="S32T16U163">K</span>*(<span class="mxinfo " id="T2:U106"><span class="var type1" id="S4T2U166">z</span>-<span class="var type1" id="S26T2U167">z1</span></span>)</span></span></span>;                              <span class="comment">%state update</span></span></span>
<span class="srcline"><span class="lineno"><a href="68,73" id="srcline73">73</a></span><span class="line"><span class="mxinfo " id="T1:U109"><span class="var type1" id="S3T1U170">P</span>=<span class="mxinfo " id="T1:U111"><span class="var type1" id="S23T1U172">P1</span>-<span class="mxinfo " id="T1:U113"><span class="var type1" id="S32T16U174">K</span>*<span class="mxinfo " id="T46:U115"><span class="var type1" id="S30T16U176">P12</span>'</span></span></span></span>;                                <span class="comment">%covariance update</span></span></span>
<span class="srcline"><span class="lineno"><a href="68,74" id="srcline74">74</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="68,75" id="srcline75">75</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="68,76" id="srcline76">76</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="68,77" id="srcline77">77</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="68,78" id="srcline78">78</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="68,79" id="srcline79">79</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="68,80" id="srcline80">80</a></span><span class="line"></span></span>
</pre>
